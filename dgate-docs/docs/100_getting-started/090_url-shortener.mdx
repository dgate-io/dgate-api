---
id: url-shortener-example
title: URL Shortener Example
description: URL shortener using DGate Modules.
tags: [modules]
---

This example demonstrates how to create a URL shortener using DGate with the [Request Handler](/docs/resources/modules#requestHandler) module function.

## Configuration-Based Setup

The easiest way to set up the URL shortener is through the configuration file. Here's the complete setup:

```yaml title="config.dgate.yaml"
version: v1
log_level: info

storage:
  type: file
  dir: .dgate/data/

proxy:
  port: 80
  host: 0.0.0.0
  
  init_resources:
    namespaces:
      - name: "url_shortener"
        tags: ["example"]
    
    collections:
      - name: "short_links"
        namespace: "url_shortener"
        visibility: private
    
    modules:
      - name: "url-shortener"
        namespace: "url_shortener"
        moduleType: javascript
        payloadFile: "modules/url_shortener.js"
    
    routes:
      - name: "url-shortener-create"
        namespace: "url_shortener"
        paths: ["/"]
        methods: ["GET", "POST"]
        modules: ["url-shortener"]
      
      - name: "url-shortener-redirect"
        namespace: "url_shortener"
        paths: ["/{id}"]
        methods: ["GET"]
        modules: ["url-shortener"]
    
    domains:
      - name: "url-shortener-domain"
        namespace: "url_shortener"
        patterns: ["url_shortener.*", "short.*"]

admin:
  port: 9080
  host: 0.0.0.0
```

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Collapse from '@site/src/components/Collapse';

<Collapse title="URL Shortener Module Code">
```javascript title="modules/url_shortener.js"
/**
 * URL Shortener Module for DGate v2
 * 
 * POST /?url=https://example.com  -> Creates short link
 * GET /:id                        -> Redirects to stored URL
 */

function requestHandler(ctx) {
    var req = ctx.request;
    var method = req.method;
    
    if (method === "POST") {
        // Create a new short link
        var url = ctx.queryParam("url");
        if (!url) {
            ctx.status(400).json({ error: "url query parameter is required" });
            return;
        }
        
        // Validate URL
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
            ctx.status(400).json({ error: "url must start with http:// or https://" });
            return;
        }
        
        // Generate short ID using hash
        var id = ctx.hashString(url);
        
        // Store the URL
        ctx.setDocument("short_links", id, { url: url });
        
        ctx.status(201).json({ 
            id: id,
            short_url: "/" + id
        });
        
    } else if (method === "GET") {
        // Get the ID from the path
        var id = ctx.pathParam("id");
        
        if (!id || id === "/" || id === "") {
            // Show info page
            ctx.json({
                name: "DGate URL Shortener",
                version: "1.0",
                usage: {
                    create: "POST /?url=https://example.com",
                    access: "GET /:id"
                }
            });
            return;
        }
        
        // Look up the short link
        var doc = ctx.getDocument("short_links", id);
        
        if (!doc || !doc.data || !doc.data.url) {
            ctx.status(404).json({ error: "Short link not found" });
            return;
        }
        
        // Redirect to the stored URL
        ctx.redirect(doc.data.url, 302);
        
    } else {
        ctx.status(405).json({ error: "Method not allowed" });
    }
}
```
</Collapse>

## CLI-Based Setup

Alternatively, you can set up the URL shortener using the CLI:

```bash
# Create a namespace for the URL shortener
dgate-cli namespace create --name url_shortener

# Create a collection for storing short links
dgate-cli collection create --namespace url_shortener --name short_links

# Create a domain with a pattern for the URL shortener
dgate-cli domain create --namespace url_shortener --name url-domain \
    --patterns "url_shortener.*,short.*"

# Create the module from a file
dgate-cli module create --namespace url_shortener --name url-shortener \
    --file ./modules/url_shortener.js

# Create routes for the URL shortener
dgate-cli route create --namespace url_shortener --name url-shortener-home \
    --paths "/" --methods "GET,POST" --modules url-shortener

dgate-cli route create --namespace url_shortener --name url-shortener-redirect \
    --paths "/{id}" --methods "GET" --modules url-shortener
```

## Testing the URL Shortener

<Tabs>
<TabItem value="httpie" label="HTTPie" default>
```sh
# Create a short link
http POST 'http://localhost:80/?url=https://dgate.io' \
    Host:url_shortener.localhost
# Output: {"id":"abc12345","short_url":"/abc12345"}

# Test the short link
http 'http://localhost:80/abc12345' \
    Host:url_shortener.localhost
# Output: Redirects to https://dgate.io
```
</TabItem>
<TabItem value="curl" label="cURL">
```sh
# Create a short link
curl -X POST 'http://localhost:80/?url=https://dgate.io' \
    -H 'Host: url_shortener.localhost'
# Output: {"id":"abc12345","short_url":"/abc12345"}

# Test the short link (follow redirects)
curl -L 'http://localhost:80/abc12345' \
    -H 'Host: url_shortener.localhost'
# Output: Redirects to https://dgate.io

# Or without following redirects to see the 302
curl -i 'http://localhost:80/abc12345' \
    -H 'Host: url_shortener.localhost'
# Output: HTTP/1.1 302 Found, Location: https://dgate.io
```
</TabItem>
</Tabs>

## How It Works

1. **POST Request**: When a URL is submitted, the module generates a short ID by hashing the URL and stores the mapping in the `short_links` collection.

2. **GET Request with ID**: When accessing a short link, the module looks up the ID in the collection and redirects to the stored URL.

3. **GET Request without ID**: Returns information about the API.

The `ctx.hashString()` helper function generates a consistent 8-character hash for any URL, ensuring the same URL always produces the same short ID.
